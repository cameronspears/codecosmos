name: Release Please

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.major }}.${{ steps.release.outputs.minor }}.${{ steps.release.outputs.patch }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          release-type: rust

  # macOS: Build universal binary and create .pkg installer
  build-macos:
    name: macOS Installer
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: macos-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin,x86_64-apple-darwin

      - name: Build (Apple Silicon)
        run: cargo build --profile release-dist --target aarch64-apple-darwin --locked

      - name: Build (Intel)
        run: cargo build --profile release-dist --target x86_64-apple-darwin --locked

      - name: Create universal binary
        run: |
          lipo -create \
            target/aarch64-apple-darwin/release-dist/cosmos \
            target/x86_64-apple-darwin/release-dist/cosmos \
            -output cosmos

      - name: Create .pkg installer
        run: |
          # Create package structure
          mkdir -p pkg-root/usr/local/bin
          cp cosmos pkg-root/usr/local/bin/
          chmod +x pkg-root/usr/local/bin/cosmos

          # Build the installer
          pkgbuild \
            --root pkg-root \
            --identifier com.cameronspears.cosmos \
            --version "${{ needs.release-please.outputs.version }}" \
            --install-location / \
            cosmos-macos-installer.pkg

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ needs.release-please.outputs.tag_name }} cosmos-macos-installer.pkg

  # Windows: Build and create installer
  build-windows:
    name: Windows Installer
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build
        run: cargo build --profile release-dist --target x86_64-pc-windows-msvc --locked

      - name: Create installer with Inno Setup
        run: |
          $version = "${{ needs.release-please.outputs.version }}"
          
          # Create Inno Setup script
          @"
          [Setup]
          AppName=Cosmos
          AppVersion=$version
          AppPublisher=Cameron Spears
          AppPublisherURL=https://github.com/cameronspears/cosmos
          DefaultDirName={autopf}\Cosmos
          DefaultGroupName=Cosmos
          OutputDir=.
          OutputBaseFilename=cosmos-windows-installer
          Compression=lzma
          SolidCompression=yes
          ChangesEnvironment=yes
          PrivilegesRequired=admin
          
          [Files]
          Source: "target\x86_64-pc-windows-msvc\release-dist\cosmos.exe"; DestDir: "{app}"; Flags: ignoreversion
          
          [Registry]
          Root: HKLM; Subkey: "SYSTEM\CurrentControlSet\Control\Session Manager\Environment"; \
              ValueType: expandsz; ValueName: "Path"; ValueData: "{olddata};{app}"; \
              Check: NeedsAddPath('{app}')
          
          [Code]
          function NeedsAddPath(Param: string): boolean;
          var
            OrigPath: string;
          begin
            if not RegQueryStringValue(HKLM, 'SYSTEM\CurrentControlSet\Control\Session Manager\Environment', 'Path', OrigPath)
            then begin
              Result := True;
              exit;
            end;
            Result := Pos(';' + Param + ';', ';' + OrigPath + ';') = 0;
          end;
          "@ | Out-File -FilePath cosmos.iss -Encoding ASCII
          
          # Run Inno Setup
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" cosmos.iss
        shell: pwsh

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release upload ${{ needs.release-please.outputs.tag_name }} cosmos-windows-installer.exe
        shell: bash

  # Linux: Build .deb and .rpm packages
  build-linux:
    name: Linux (${{ matrix.arch }})
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        include:
          - arch: x64
            target: x86_64-unknown-linux-gnu
            deb_arch: amd64
          - arch: arm64
            target: aarch64-unknown-linux-gnu
            deb_arch: arm64
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Install packaging tools
        run: sudo apt-get install -y rpm

      - name: Build
        run: cargo build --profile release-dist --target ${{ matrix.target }} --locked
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Create .deb package
        run: |
          VERSION="${{ needs.release-please.outputs.version }}"
          PKG_NAME="cosmos_${VERSION}_${{ matrix.deb_arch }}"
          
          mkdir -p "${PKG_NAME}/DEBIAN"
          mkdir -p "${PKG_NAME}/usr/local/bin"
          
          cp target/${{ matrix.target }}/release-dist/cosmos "${PKG_NAME}/usr/local/bin/"
          chmod +x "${PKG_NAME}/usr/local/bin/cosmos"
          
          cat > "${PKG_NAME}/DEBIAN/control" << EOF
          Package: cosmos
          Version: ${VERSION}
          Section: devel
          Priority: optional
          Architecture: ${{ matrix.deb_arch }}
          Maintainer: Cameron Spears <github@cameronspears.com>
          Description: A contemplative vibe coding companion
           Terminal-first codebase steward that uses AI to suggest
           improvements and ship fixes as branches and PRs.
          EOF
          
          dpkg-deb --build "${PKG_NAME}"

      - name: Create tarball (fallback)
        run: |
          cd target/${{ matrix.target }}/release-dist
          chmod +x cosmos
          tar -czvf ../../../cosmos-linux-${{ matrix.arch }}.tar.gz cosmos

      - name: Upload to Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release upload ${{ needs.release-please.outputs.tag_name }} cosmos_${{ needs.release-please.outputs.version }}_${{ matrix.deb_arch }}.deb
          gh release upload ${{ needs.release-please.outputs.tag_name }} cosmos-linux-${{ matrix.arch }}.tar.gz
